#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”„ Running pre-commit checks..."

# Run linting first (quick check)
echo "ğŸ“ Running linter..."
pnpm lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed. Please fix linting errors before committing."
  exit 1
fi

# Run critical user journey tests
echo "ğŸ§ª Running critical user journey tests..."
cd apps/web && pnpm run test:e2e:critical --reporter=dot --workers=1

if [ $? -ne 0 ]; then
  echo "âŒ Critical user journey tests failed!"
  echo "ğŸ” The following user journeys are broken:"
  echo "   - User authentication and sign-up"
  echo "   - Gmail connection and email fetching"
  echo "   - Data pipeline processing"
  echo "   - Onboarding flow"
  echo "   - No dummy data validation"
  echo ""
  echo "ğŸ’¡ To debug:"
  echo "   pnpm run test:e2e:critical --headed    # Run with browser visible"
  echo "   pnpm run test:e2e:ui                   # Run with Playwright UI"
  echo "   pnpm run test:e2e:report               # View last test report"
  echo ""
  echo "ğŸš« Commit blocked. Please fix failing tests before committing."
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit - user journeys are protected!"