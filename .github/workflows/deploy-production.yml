name: Deploy Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  validate:
    name: Validate Build
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache turbo build artifacts
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Check formatting
        run: pnpm format:check

      - name: Lint codebase
        run: pnpm lint

      - name: Type check
        run: pnpm type-check

      - name: Run unit tests
        run: pnpm test:run

      - name: Run end-to-end tests
        run: pnpm test:e2e

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 20
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      staging-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Restore turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project artifacts
        run: pnpm build

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Staging)
        id: deploy
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          url=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --yes --meta githubCommit=$GITHUB_SHA)
          echo "url=$url" >> "$GITHUB_OUTPUT"
          echo "Staging deployment URL: $url"

      - name: Smoke test staging deployment
        env:
          STAGING_URL: ${{ steps.deploy.outputs.url }}
        run: |
          echo "Waiting for staging deployment to be ready..."
          for attempt in {1..10}; do
            if curl -fsS "$STAGING_URL/api/monitoring/health"; then
              echo "Staging health check succeeded"
              exit 0
            fi
            sleep 10
          done
          echo "Staging health check failed" >&2
          exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    timeout-minutes: 25
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      production-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Restore turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project artifacts
        run: pnpm build

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Production)
        id: deploy
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          url=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --meta githubCommit=$GITHUB_SHA)
          echo "url=$url" >> "$GITHUB_OUTPUT"
          echo "Production deployment URL: $url"

      - name: Verify production deployment
        env:
          PRODUCTION_URL: ${{ steps.deploy.outputs.url }}
        run: |
          echo "Waiting for production deployment to be ready..."
          for attempt in {1..10}; do
            if curl -fsS "$PRODUCTION_URL/api/monitoring/health"; then
              echo "Production health check succeeded"
              break
            fi
            sleep 15
          done

          response=$(curl -s -I "$PRODUCTION_URL")
          echo "$response" | grep -i "strict-transport-security"
          echo "$response" | grep -i "content-security-policy"
          echo "$response" | grep -i "x-content-type-options"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure() && needs.deploy-production.result == 'failure'
    timeout-minutes: 10

    steps:
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Rollback to previous production deployment
        run: vercel rollback production --token=${{ secrets.VERCEL_TOKEN }}

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs:
      - deploy-staging
      - deploy-production
    if: always()

    steps:
      - name: Summarize deployment
        uses: actions/github-script@v7
        env:
          STAGING_URL: ${{ needs.deploy-staging.outputs.staging-url }}
          PRODUCTION_URL: ${{ needs.deploy-production.outputs.production-url }}
          DEPLOY_STATUS: ${{ needs.deploy-production.result }}
        with:
          script: |
            const core = require('@actions/core');
            const stagingUrl = process.env.STAGING_URL;
            const productionUrl = process.env.PRODUCTION_URL;
            const status = process.env.DEPLOY_STATUS || 'unknown';

            core.summary.addHeading('Deployment Summary');
            core.summary.addRaw(`Status: **${status.toUpperCase()}**`);
            if (stagingUrl) {
              core.summary.addLink('Staging Deployment', stagingUrl);
            }
            if (productionUrl) {
              core.summary.addLink('Production Deployment', productionUrl);
            }
            await core.summary.write();

      - name: Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Deployment ${{ needs.deploy-production.result }} for ${{ github.repository }}",
              "attachments": [
                {
                  "color": "${{ needs.deploy-production.result == 'success' && '#36a64f' || '#d73a49' }}",
                  "fields": [
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "${{ github.sha }}",
                      "short": true
                    },
                    {
                      "title": "Staging",
                      "value": "${{ needs.deploy-staging.outputs.staging-url || 'n/a' }}",
                      "short": false
                    },
                    {
                      "title": "Production",
                      "value": "${{ needs.deploy-production.outputs.production-url || 'n/a' }}",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
